<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Roboto', sans-serif;
        background-color: #f0f2f5;
        margin: 0;
        color: #333;
      }
      .header {
        background-color: #fff;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        position: relative;
      }
      .header .logo {
        height: 35px;
      }
      .header h1 {
        margin: 0;
        font-size: 1.5rem;
        color: #005f90;
        font-weight: 500;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
      }
      .btn-link {
        padding: 0.6rem 1.2rem;
        background-color: #005f90;
        color: white;
        font-weight: 500;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        transition: background-color 0.2s;
      }
      .btn-link:hover {
        background-color: #004c73;
      }
      .main-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
      }
      .panel {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }
      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
      }
      .panel-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 500;
      }
      .filter-container { display: flex; gap: 10px; align-items: center; }
      .filter-container label { font-weight: 500; }
      .filter-container select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 1em; }
      .styled-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }
      .styled-table thead tr {
        background-color: #005f90;
        color: #ffffff;
        text-align: left;
        font-weight: bold;
      }
      .styled-table th, .styled-table td {
        padding: 12px 15px;
      }
      .styled-table tbody tr {
        border-bottom: 1px solid #f0f0f0;
      }
      .styled-table tbody tr:last-of-type {
        border-bottom: 2px solid #005f90;
      }
      #pagination-controls { text-align: center; margin-top: 20px; }
      #pagination-controls button { padding: 8px 16px; cursor: pointer; border-radius: 4px; border: 1px solid #005f90; background-color: white; color: #005f90; font-weight: bold; }
      #pagination-controls button:disabled { cursor: not-allowed; opacity: 0.5; }
      #page-info { margin: 0 15px; font-weight: bold; }

      /* Styles for the session timeout modal */
      .timeout-modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
      .timeout-modal-content { background-color: #fefefe; margin: auto; padding: 2rem 2.5rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 450px; text-align: center; }
      .timeout-modal-content h2 { margin-top: 0; color: #005f90; }
      #session-timeout-button { margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://appscript-cdn.co.uk/GatePassProject/approva/Approva_favicon.png" alt="Approva Logo" class="logo">
        <h1>System Action Logs</h1>
        <a href="<?= ScriptApp.getService().getUrl() ?>?page=Landing" class="btn-link">Main Menu</a>
    </div>

    <div class="main-container">
       <div class="panel">
            <div class="panel-header">
                <h2>Log Entries</h2>
                <div class="filter-container">
                    <label for="action-filter">Filter by Action:</label>
                    <select id="action-filter" onchange="handleFilterChange()"></select>
                </div>
            </div>
            <div style="overflow-x:auto;">
              <table id="logs-table" class="styled-table">
                  <thead><tr><th>Timestamp</th><th>Performed By</th><th>Action</th><th>Details</th></tr></thead>
                  <tbody id="logs-table-body"></tbody>
              </table>
            </div>
            <div id="loading-message">Loading...</div>
            <div id="pagination-controls">
                <button id="prev-button" onclick="changePage('prev')">Previous</button>
                <span id="page-info"></span>
                <button id="next-button" onclick="changePage('next')">Next</button>
            </div>
        </div>
    </div>

    <div id="session-timeout-modal" class="timeout-modal-overlay">
      <div class="timeout-modal-content">
        <h2>Session Expired</h2>
        <p>Your session has timed out due to inactivity. Please log in again to continue.</p>
        <button id="session-timeout-button" class="btn-link">Go to Login</button>
      </div>
    </div>

    <script>
      let currentPageLogs = [];
      let currentPage = 1;
      let totalPages = 1;
      let currentFilter = 'ALL';
      let sessionToken = '';
      const PAGE_SIZE = 50; 

      window.addEventListener('DOMContentLoaded', () => {
        sessionToken = sessionStorage.getItem('sessionToken');
        if (!sessionToken) {
    const modal = document.getElementById('session-timeout-modal');
    if (modal) {
        modal.style.display = 'flex';
        const modalButton = document.getElementById('session-timeout-button');
        if (modalButton) {
            modalButton.onclick = () => {
                window.top.location.href = '<?= ScriptApp.getService().getUrl() ?>';
            };
        }
    }
    return; // Stop the rest of the script from running
}

        google.script.run
            .withSuccessHandler(populateFilter)
            .withFailureHandler(handleFailure)
            .getUniqueLogActions(sessionToken);
        
        loadLogs(currentPage, currentFilter);
      });
      
      function handleFailure(err) {
        setLoadingState(true, 'Error: ' + err.message);
        if (err.message.includes("Access Denied") || err.message.includes("Authentication failed") || err.message.includes("session may have expired")) {
            sessionStorage.removeItem('sessionToken');
            const modal = document.getElementById('session-timeout-modal');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('session-timeout-button').onclick = () => {
                    window.top.location.href = '<?= ScriptApp.getService().getUrl() ?>';
                };
            }
        } else {
            // Non-session errors are shown in the loading message area
            console.error(err);
        }
      }

      function loadLogs(page, filter) {
        setLoadingState(true);
        currentFilter = filter;
        google.script.run
          .withSuccessHandler(response => {
            currentPageLogs = response.logs || [];
            currentPage = response.currentPage;
            totalPages = response.totalPages;
            renderLogsTable();
            updatePaginationControls();
            setLoadingState(false);
          })
          .withFailureHandler(handleFailure)
          .getActionLogs(sessionToken, page, PAGE_SIZE, filter);
      }
      
      function handleFilterChange() {
        const filterValue = document.getElementById('action-filter').value;
        loadLogs(1, filterValue);
      }
      
      function populateFilter(actions) {
        const filterSelect = document.getElementById('action-filter');
        filterSelect.innerHTML = '<option value="ALL">Show All Actions</option>';
        actions.forEach(action => {
          const option = document.createElement('option');
          option.value = action;
          option.textContent = action.replace(/_/g, ' ').replace(/\b\w/g, char => char.toUpperCase());
          filterSelect.appendChild(option);
        });
      }

      function renderLogsTable() {
        const tableBody = document.getElementById('logs-table-body');
        tableBody.innerHTML = '';
        
        if (currentPageLogs.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No logs found for this filter.</td></tr>';
          return;
        }

        const fragment = document.createDocumentFragment();
        currentPageLogs.forEach(log => {
          const tr = document.createElement('tr');
          const timestamp = log[0] || 'Invalid Date';
          const username = log[1] || '';
          const action = log[2] || '';
          const details = log[3] || '';
          tr.innerHTML = `<td>${timestamp}</td><td>${username}</td><td>${action}</td><td>${details}</td>`;
          fragment.appendChild(tr);
        });
        tableBody.appendChild(fragment);
      }
      
      function changePage(direction) {
        let newPage = currentPage;
        if (direction === 'next' && currentPage < totalPages) {
            newPage++;
        } else if (direction === 'prev' && currentPage > 1) {
            newPage--;
        }
        
        if (newPage !== currentPage) {
            loadLogs(newPage, currentFilter);
        }
      }

      function updatePaginationControls() {
        const pageInfo = document.getElementById('page-info');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const controls = document.getElementById('pagination-controls');

        if (totalPages > 0) {
            controls.style.display = 'block';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
        } else {
            controls.style.display = 'none';
        }
      }

      function setLoadingState(isLoading, message = 'Loading...') {
        const loadingMessage = document.getElementById('loading-message');
        const table = document.getElementById('logs-table');
        const pagination = document.getElementById('pagination-controls');
        
        if (isLoading) {
            loadingMessage.textContent = message;
            loadingMessage.style.display = 'block';
            table.style.display = 'none';
            pagination.style.display = 'none';
        } else {
            loadingMessage.style.display = 'none';
            table.style.display = 'table';
        }
      }
    </script>
</body>
</html>
