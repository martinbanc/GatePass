<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    :root {
      --primary-color: #005f90;
      --success-color: #28a745;
      --danger-color: #dc3545;
      --light-gray: #eef2f5;
      --dark-text: #333;
      --border-color: #ccc;
      --border-radius: 8px;
    }
    body, h1, h2, h3, h5, label, input, select, button, p, textarea {
      margin: 0; padding: 0; font-family: 'Roboto', sans-serif; box-sizing: border-box;
    }
    body {
      background: var(--light-gray); padding: 15px 10px 120px; font-size: 16px; color: var(--dark-text);
    }
    .container{
      margin: 0 auto; background:#fff; padding: 25px; border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: left; max-width: 720px; width: 100%;
    }
    .app-header { display: flex; align-items: center; margin-bottom: 20px; gap: 15px; }
    #app-title { font-size: 1.8em; font-weight: 700; color: var(--dark-text); margin-right: auto; }
    #app-logo { height: 45px; width: auto; }
    .back-button {
        background-color: #6c757d;
        color: white;
        padding: 8px 15px;
        text-decoration: none;
        border-radius: 5px;
        font-size: 0.9em;
        font-weight: 500;
        transition: background-color 0.2s;
        flex-shrink: 0;
    }
    .back-button:hover { background-color: #5a6268; }
    .location-header {
      padding: 12px 15px; color: #fff; border-radius: 5px; background-color: var(--primary-color);
      margin-bottom: 25px; text-align: center; font-size: 1.15em; font-weight: 500;
    }
    .category-group-wrapper { padding: 20px; margin-bottom: 25px; background-color: #fdfdfd; border: 1px solid #e0e0e0; border-radius: var(--border-radius); }
    h5.dynamic-question-category {
      font-size: 1.25em; margin: 0 0 20px 0; padding-bottom: 12px; color: var(--primary-color); border-bottom: 2px solid var(--primary-color);
    }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 500; color:#444; }
    label.multiple-choice-label { font-weight: normal; cursor: pointer; }
    .dynamic-input, input, textarea, select { 
      padding: 12px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 1em; width: 100%; display: block;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .dynamic-input:focus, input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(0, 95, 144, 0.15);
    }
    #form-actions-footer { text-align: center; padding: 15px; position: fixed; bottom: 0; left: 0; width: 100%; background-color: rgba(255,255,255,0.95); border-top: 1px solid #ddd; box-shadow: 0 -2px 8px rgba(0,0,0,0.08); backdrop-filter: blur(5px); }
    #form-actions-footer button { padding: 14px 30px; font-size: 1.1em; font-weight:bold; border:none; border-radius:5px; cursor:pointer; background:var(--primary-color); color:#fff; transition: background-color 0.2s; }
    #form-actions-footer button:disabled { background-color: #b0bec5 !important; cursor: not-allowed; }
    .message{ margin-bottom: 20px; display: none; text-align: center; font-size: 1em; padding:15px; border-radius:4px; font-weight: 500;}
    .message.success-message { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7;}
    .message.error-message { background-color: #ffebee; color: #c62828; border: 1px solid #ef9a9a;}
    .message.info-message { background-color: #e3f2fd; color: #0d47a1; border: 1px solid #90caf9;}
    .item-row { background: #fafafa; border: 1px solid #e9e9e9; border-radius: 6px; padding: 20px; margin-bottom: 15px; position: relative; }
    .item-row .form-group label { font-weight: normal; color: #555; }
    #add-item-btn { 
      background-color: transparent; color: var(--success-color); border: 2px solid var(--success-color);
      padding: 10px 18px; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight: bold;
      transition: background-color 0.2s, color 0.2s;
    }
    #add-item-btn:hover { background-color: var(--success-color); color: white; }
    .remove-item-btn { position: absolute; top: 10px; right: 10px; background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: background-color 0.2s; }
    .remove-item-btn:hover { background-color: #b71c1c; }
    .multiple-choice-group { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; padding-top: 5px; }
    .multiple-choice-option { display: flex; align-items: center; }
    .multiple-choice-option input { width: auto; margin-right: 8px; }
    .other-text-input { margin-top: 10px; }
    .photo-upload-container { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
    .photo-upload-button {
        display: inline-block; padding: 10px 15px; background-color: #6c757d; color: white;
        border-radius: 4px; cursor: pointer; font-weight: bold; text-align: center; font-size: 0.9em;
    }
    .preview-container { margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .preview-item { position: relative; }
    .preview-image { width: 100%; height: 100px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
    .remove-photo-btn {
        position: absolute; top: -5px; right: -5px; background: #dc3545; color: white;
        border: none; border-radius: 50%; width: 22px; height: 22px;
        font-weight: bold; font-size: 14px; cursor: pointer; line-height: 22px; text-align: center;
    }
</style>
</head>
<body>
  <div class="container">
    <div class="app-header">
      <img id="app-logo" src="https://appscript-cdn.co.uk/GatePassProject/approva/Approva_favicon.png" alt="Approva Logo">
      <h1 id="app-title">Approva Gate Pass</h1>
      <a href="<?= ScriptApp.getService().getUrl() ?>?location=<?= location.identifier ?>" class="back-button">Go Back</a>
    </div>
    <div id="location-display" class="location-header">Loading...</div>
    <div id="message" class="message"></div>
    <form id="gate-pass-form">
      <input type="hidden" id="form-location" name="location" value="">
      <input type="hidden" id="form-type" name="formType" value="">
      <div id="dynamic-form-content">
        <p id="loading-message" class="message info-message" style="display: block;">Loading form...</p>
      </div>
    </form>
  </div>

  <div id="form-actions-footer">
    <button type="submit" id="submit-button" form="gate-pass-form" style="display:none;">Submit Gate Pass</button>
  </div>

<script>
    const locationData = <?!= JSON.stringify(location) ?>;
    const formType = "<?!= formType ?>";
    const serverData = <?!= JSON.stringify(data) ?>;
    let itemCounter = 0;
    let itemPhotos = {};

    document.addEventListener('DOMContentLoaded', function() {
      const formTitle = formType === 'entering' ? 'Items Entering Site' : 'Items Leaving Site';
      document.getElementById('location-display').textContent = `Location: ${locationData.name} - ${formTitle}`;
      document.getElementById('form-location').value = locationData.name;
      document.getElementById('form-type').value = formType;
      
      buildForm(serverData);
    });

    function showError(error) {
      const msgDiv = document.getElementById('message');
      msgDiv.textContent = 'Error: ' + error.message;
      msgDiv.className = 'message error-message';
      msgDiv.style.display = 'block';
      document.getElementById('loading-message').style.display = 'none';
      window.scrollTo(0, 0);
    }
    
    function readFileAsBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64Data = reader.result.split(',')[1];
          resolve({ name: file.name, type: file.type, data: base64Data });
        };
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    async function handleFileSelect(event, itemIndex) {
      const files = event.target.files;
      if (!files) return;
      if (!itemPhotos[itemIndex]) itemPhotos[itemIndex] = [];

      for (const file of files) {
        if (file.type.startsWith('image/')) {
          try {
            const photoData = await readFileAsBase64(file);
            itemPhotos[itemIndex].push(photoData);
          } catch (error) {
            console.error("Error reading file:", error);
          }
        }
      }
      renderPreviews(itemIndex);
      event.target.value = '';
    }

    function renderPreviews(itemIndex) {
      const previewContainer = document.getElementById(`preview-container_${itemIndex}`);
      if (!previewContainer) return;
      previewContainer.innerHTML = '';

      (itemPhotos[itemIndex] || []).forEach((photo, photoIndex) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';
        const img = document.createElement('img');
        img.className = 'preview-image';
        img.src = `data:${photo.type};base64,${photo.data}`;
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-photo-btn';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = () => removePhoto(itemIndex, photoIndex);
        previewItem.appendChild(img);
        previewItem.appendChild(removeBtn);
        previewContainer.appendChild(previewItem);
      });
    }
    
    function removePhoto(itemIndex, photoIndex) {
      if (itemPhotos[itemIndex]) {
        itemPhotos[itemIndex].splice(photoIndex, 1);
        renderPreviews(itemIndex);
      }
    }

    function addNewItemRow() {
        const itemIndex = itemCounter;
        const itemsContainer = document.getElementById('items-container');
        const itemRow = document.createElement('div');
        itemRow.className = 'item-row';
        itemRow.id = `item-row_${itemIndex}`;
        
        const removeButton = document.createElement('button');
        removeButton.type = 'button';
        removeButton.className = 'remove-item-btn';
        removeButton.textContent = 'âœ•';
        removeButton.onclick = () => {
          itemRow.remove();
          delete itemPhotos[itemIndex];
        };
        itemRow.appendChild(removeButton);

        serverData.itemQuestions.forEach(q => {
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            const label = document.createElement('label');
            label.textContent = q.title;
            formGroup.appendChild(label);
            formGroup.appendChild(createInputElement(q, `_${itemIndex}`));
            itemRow.appendChild(formGroup);
        });
        
        const photoContainer = document.createElement('div');
        photoContainer.className = 'photo-upload-container';
        photoContainer.innerHTML = `
          <label for="photo-input_${itemIndex}" class="photo-upload-button">ðŸ“· Add Item Photos</label>
          <input type="file" id="photo-input_${itemIndex}" accept="image/*" multiple style="display:none;">
          <div class="preview-container" id="preview-container_${itemIndex}"></div>
        `;
        itemRow.appendChild(photoContainer);
        itemsContainer.appendChild(itemRow);
        
        document.getElementById(`photo-input_${itemIndex}`).addEventListener('change', (e) => handleFileSelect(e, itemIndex));

        itemCounter++;
    }

    function createInputElement(q, suffix = '') {
      let inputElement;
      const inputId = `${q.id}${suffix}`;
      const elementContainer = document.createDocumentFragment();

      switch (q.type.toLowerCase()) {
        case 'textarea':
          inputElement = document.createElement('textarea');
          inputElement.id = inputId;
          inputElement.name = inputId;
          elementContainer.appendChild(inputElement);
          break;
        case 'select':
          inputElement = document.createElement('select');
          inputElement.id = inputId;
          inputElement.name = inputId;
          inputElement.appendChild(new Option('Select...', ''));
          q.options.forEach(opt => inputElement.appendChild(new Option(opt, opt)));
          
          const otherOptionValue = q.options.find(opt => opt.toLowerCase().startsWith('other'));
          
          if (otherOptionValue) {
            const otherInputId = `other_text_for_${inputId}`;
            
            inputElement.onchange = (event) => {
              const otherTextInput = document.getElementById(otherInputId);
              if (otherTextInput) {
                otherTextInput.style.display = (event.target.value === otherOptionValue) ? 'block' : 'none';
              }
            };
            
            const otherTextInput = document.createElement('input');
            otherTextInput.type = 'text';
            otherTextInput.id = otherInputId;
            otherTextInput.name = `${inputId}_other_text`;
            otherTextInput.placeholder = 'Please specify';
            otherTextInput.className = 'other-text-input';
            otherTextInput.style.display = 'none';
            
            elementContainer.appendChild(inputElement);
            elementContainer.appendChild(otherTextInput);
          } else {
             elementContainer.appendChild(inputElement);
          }
          break;
        case 'radio':
        case 'checkbox':
          inputElement = document.createElement('div');
          inputElement.className = 'multiple-choice-group';
          q.options.forEach((opt, index) => {
            const optionWrapper = document.createElement('div');
            optionWrapper.className = 'multiple-choice-option';
            const choiceInput = document.createElement('input');
            choiceInput.type = q.type.toLowerCase();
            choiceInput.name = inputId;
            choiceInput.value = opt;
            choiceInput.id = `${inputId}_${index}`;
            const choiceLabel = document.createElement('label');
            choiceLabel.textContent = opt;
            choiceLabel.htmlFor = choiceInput.id;
            choiceLabel.className = 'multiple-choice-label';
            optionWrapper.append(choiceInput, choiceLabel);
            inputElement.appendChild(optionWrapper);
          });
          elementContainer.appendChild(inputElement);
          break;
        default:
          inputElement = document.createElement('input');
          inputElement.type = q.type.toLowerCase();
          inputElement.id = inputId;
          inputElement.name = inputId;
          elementContainer.appendChild(inputElement);
      }
      return elementContainer;
    }

    function buildItemsSection(container, categoryName) {
        const categoryWrapper = document.createElement('div');
        categoryWrapper.className = 'category-group-wrapper';
        const categoryTitle = document.createElement('h5');
        categoryTitle.className = 'dynamic-question-category';
        categoryTitle.textContent = categoryName;
        categoryWrapper.appendChild(categoryTitle);
        const itemsContainer = document.createElement('div');
        itemsContainer.id = 'items-container';
        categoryWrapper.appendChild(itemsContainer);
        const addButton = document.createElement('button');
        addButton.type = 'button';
        addButton.textContent = 'ï¼‹ Add Another Item';
        addButton.id = 'add-item-btn';
        addButton.addEventListener('click', addNewItemRow);
        categoryWrapper.appendChild(addButton);
        container.appendChild(categoryWrapper);
        addNewItemRow();
    }
    
    function buildForm(data) {
      const { mainQuestions, itemQuestions, categoryOrder } = data;
      document.getElementById('loading-message').style.display = 'none';
      const formContent = document.getElementById('dynamic-form-content');
      formContent.innerHTML = '';
      if (!categoryOrder || categoryOrder.length === 0) {
        showError({ message: 'No questions were found in the sheet.' });
        return;
      }
      const mainCategories = (mainQuestions || []).reduce((acc, q) => {
        acc[q.category] = acc[q.category] || [];
        acc[q.category].push(q);
        return acc;
      }, {});
      categoryOrder.forEach(categoryName => {
        if (categoryName === 'Item Information') {
          if (itemQuestions && itemQuestions.length > 0) {
            buildItemsSection(formContent, categoryName);
          }
        } 
        else if (mainCategories[categoryName]) {
          const categoryWrapper = document.createElement('div');
          categoryWrapper.className = 'category-group-wrapper';
          const categoryTitle = document.createElement('h5');
          categoryTitle.className = 'dynamic-question-category';
          categoryTitle.textContent = categoryName;
          categoryWrapper.appendChild(categoryTitle);
          mainCategories[categoryName].forEach(q => {
            const formGroup = document.createElement('div');
            formGroup.className = 'form-group';
            const label = document.createElement('label');
            label.textContent = q.title;
            label.htmlFor = q.id;
            formGroup.appendChild(label);
            formGroup.appendChild(createInputElement(q));
            categoryWrapper.appendChild(formGroup);
          });
          formContent.appendChild(categoryWrapper);
        }
      });
      document.getElementById('submit-button').style.display = 'inline-block';
    }

    document.getElementById('gate-pass-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const submitBtn = document.getElementById('submit-button');
      submitBtn.textContent = 'Submitting...';
      submitBtn.disabled = true;

      const form = document.getElementById('gate-pass-form');
      const formData = new FormData(form);
      let formObject = {};
      for (const [key, value] of formData.entries()) {
        formObject[key] = value;
      }
      
      for(const itemIndex in itemPhotos) {
        if(itemPhotos[itemIndex].length > 0) {
          formObject[`photos_${itemIndex}`] = itemPhotos[itemIndex];
        }
      }

      google.script.run
        .withSuccessHandler(function(response) {
            const msgDiv = document.getElementById('message');
            msgDiv.textContent = response;
            msgDiv.className = 'message success-message';
            msgDiv.style.display = 'block';
            form.reset();
            itemPhotos = {};
            document.getElementById('items-container').innerHTML = '';
            addNewItemRow();
            window.scrollTo(0, 0);
            submitBtn.textContent = 'Submit Another Pass';
            submitBtn.disabled = false;
        })
        .withFailureHandler(function(error) {
            showError(error);
            submitBtn.textContent = 'Submit Gate Pass';
            submitBtn.disabled = false;
        })
        .saveResponse(formObject);
    });
</script>
</body>
</html>
