<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Roboto', sans-serif;
        background-color: #f0f2f5;
        margin: 0;
        color: #333;
      }
      .header {
        background-color: #fff;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .header .logo {
        height: 35px;
      }
      .header h1 {
        margin: 0;
        font-size: 1.5rem;
        color: #005f90;
        font-weight: 500;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
      }
      .btn-link, .action-cell button {
        padding: 0.6rem 1.2rem;
        background-color: #005f90;
        color: white;
        font-weight: 500;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        transition: background-color 0.2s;
      }
      .btn-link:hover {
        background-color: #004c73;
      }
      .main-container {
        padding: 2rem;
        max-width: 1400px;
        margin: 0 auto;
      }
      .admin-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 2rem;
      }
      @media (min-width: 1200px) {
        .admin-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        .users-panel, #sites-panel {
          grid-column: span 1;
        }
        .users-panel {
          grid-column: 1 / 3;
        }
      }
      .panel {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      }
      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 1rem;
        margin-bottom: 2rem;
      }
      .panel-header h2 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 500;
      }
      .styled-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
      }
      .styled-table thead tr {
        background-color: #005f90;
        color: #ffffff;
        text-align: left;
        font-weight: bold;
      }
      .styled-table th, .styled-table td {
        padding: 12px 15px;
      }
      .styled-table tbody tr {
        border-bottom: 1px solid #f0f0f0;
      }
      .styled-table tbody tr:last-of-type {
        border-bottom: 2px solid #005f90;
      }
      .styled-table .action-cell {
        white-space: nowrap;
      }
      .action-cell button {
        font-size: 0.85rem;
        padding: 6px 12px;
        margin-right: 5px;
        border: 1px solid transparent;
      }
      button.edit-btn { background-color: #6c757d; }
      button.delete-btn { background-color: #dc3545; }
      button.reset-btn { background-color: #ffc107; color: #212529; }
      .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
      .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
      .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px;}
      .modal-header h2 { margin: 0; font-size: 1.25rem;}
      .close-button { font-size: 1.5rem; font-weight: bold; cursor: pointer; color: #888; }
      .form-group { margin-bottom: 15px; }
      .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
      .form-group input, .form-group select { width: 100%; padding: 10px; font-size: 1rem; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box; }
      .form-group button { width: 100%; margin-top: 10px; }
      #loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;}
      .spinner { border: 5px solid #f3f3f3; border-top: 5px solid #005f90; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      
      /* Styles for the session timeout modal */
      .timeout-modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
      .timeout-modal-content { background-color: #fefefe; margin: auto; padding: 2rem 2.5rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 450px; text-align: center; }
      .timeout-modal-content h2 { margin-top: 0; color: #005f90; }
      #session-timeout-button { margin-top: 1rem; }
    </style>
</head>
<body>
    <div id="loader-overlay" style="display: none;"><div class="spinner"></div></div>

    <div class="header">
      <img src="https://appscript-cdn.co.uk/GatePassProject/approva/Approva_favicon.png" alt="Approva Logo" class="logo">
      <h1>Admin Management</h1>
      <a href="<?= ScriptApp.getService().getUrl() ?>?page=Landing" class="btn-link">Main Menu</a>
    </div>

    <div class="main-container">
      <div class="admin-grid">
        <div class="panel users-panel">
          <div class="panel-header">
            <h2>Users</h2>
            <button id="add-user-btn" class="btn-link" onclick="openUserModal()">+ Add New User</button>
          </div>
          <div style="overflow-x:auto;">
            <table class="styled-table">
              <thead><tr><th>Full Name</th><th>Username</th><th>Role</th><th>Site</th><th>Status</th><th>Actions</th></tr></thead>
              <tbody id="users-table-body"></tbody>
            </table>
          </div>
        </div>
        
        <div id="sites-panel" class="panel">
          <div class="panel-header">
            <h2>Sites</h2>
            <button class="btn-link" onclick="openSiteModal()">+ Add New Site</button>
          </div>
          <div style="overflow-x:auto;">
            <table class="styled-table">
              <thead><tr><th>Site ID</th><th>Site Name</th><th>APM Emails</th><th>Actions</th></tr></thead>
              <tbody id="sites-table-body"></tbody>
            </table>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <h2>Approvers</h2>
            <button id="add-approver-btn" class="btn-link" onclick="openApproverModal()">+ Add New Approver</button>
          </div>
          <div style="overflow-x:auto;">
            <table class="styled-table">
              <thead><tr><th>Full Name</th><th>Email</th><th>Site</th><th>Actions</th></tr></thead>
              <tbody id="approvers-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <div id="user-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="user-modal-title">Add New User</h2>
          <span class="close-button" onclick="closeModal('user-modal')">&times;</span>
        </div>
        <form id="user-form">
            <input type="hidden" id="user-edit-username" />
            <div class="form-group">
                <label for="user-fullName">Full Name</label>
                <input type="text" id="user-fullName" required>
            </div>
            <div class="form-group">
                <label for="user-username">Username (Email)</label>
                <input type="email" id="user-username" required>
            </div>
            <div class="form-group">
                <label for="user-position">Position</label>
                <input type="text" id="user-position">
            </div>
            <div class="form-group">
                <label for="user-role">Role</label>
                <select id="user-role" required></select>
            </div>
            <div class="form-group">
                <label for="user-siteId">Site</label>
                <select id="user-siteId" required></select>
            </div>
             <div class="form-group">
                <label for="user-isActive">Status</label>
                <select id="user-isActive"><option value="true">Active</option><option value="false">Inactive</option></select>
            </div>
            <div class="form-group">
              <button type="submit" class="btn-link">Save User</button>
            </div>
        </form>
      </div>
    </div>
    
    <div id="site-modal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2 id="site-modal-title">Add New Site</h2>
              <span class="close-button" onclick="closeModal('site-modal')">&times;</span>
          </div>
          <form id="site-form">
              <div class="form-group">
                  <label for="site-siteId">Site ID (e.g., Sarnia)</label>
                  <input type="text" id="site-siteId" required>
              </div>
              <div class="form-group">
                  <label for="site-siteName">Site Name (e.g., Sarnia Site)</label>
                  <input type="text" id="site-siteName" required>
              </div>
              <div class="form-group">
                  <label for="site-apm-email1">Asset Protection Manager Email 1</label>
                  <input type="email" id="site-apm-email1">
              </div>
              <div class="form-group">
                  <label for="site-apm-email2">Asset Protection Manager Email 2</label>
                  <input type="email" id="site-apm-email2">
              </div>
              <div class="form-group">
                  <button type="submit" class="btn-link">Save Site</button>
              </div>
          </form>
      </div>
    </div>

    <div id="approver-modal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h2 id="approver-modal-title">Add New Approver</h2>
              <span class="close-button" onclick="closeModal('approver-modal')">&times;</span>
          </div>
          <form id="approver-form">
              <input type="hidden" id="approver-edit-id">
              <div class="form-group">
                  <label for="approver-fullName">Full Name</label>
                  <input type="text" id="approver-fullName" required>
              </div>
              <div class="form-group">
                  <label for="approver-email">Email</label>
                  <input type="email" id="approver-email" required>
              </div>
              <div class="form-group">
                  <label for="approver-siteId">Site</label>
                  <select id="approver-siteId" required></select>
              </div>
              <div class="form-group">
                  <button type="submit" class="btn-link">Save Approver</button>
              </div>
          </form>
      </div>
    </div>

    <div id="session-timeout-modal" class="timeout-modal-overlay">
      <div class="timeout-modal-content">
        <h2>Session Expired</h2>
        <p>Your session has timed out due to inactivity. Please log in again to continue.</p>
        <button id="session-timeout-button" class="btn-link">Go to Login</button>
      </div>
    </div>

    <script>
    let sites = [], users = [], approvers = [], currentUser = {};
    let sessionToken = '';
    const ROLES = { SUPER_USER: 'Super user', REGIONAL_MANAGER: 'Regional Manager', SITE_SUPERVISOR: 'Site Supervisor', SECURITY_OFFICER: 'Security Officer' };

    window.addEventListener('DOMContentLoaded', () => {
        sessionToken = sessionStorage.getItem('sessionToken');
        if (!sessionToken) {
    const modal = document.getElementById('session-timeout-modal');
    if (modal) {
        modal.style.display = 'flex';
        const modalButton = document.getElementById('session-timeout-button');
        if (modalButton) {
            modalButton.onclick = () => {
                window.top.location.href = '<?= ScriptApp.getService().getUrl() ?>';
            };
        }
    }
    return; // Stop the rest of the script from running
}

        setLoading(true);
        google.script.run
            .withSuccessHandler(onDataLoaded)
            .withFailureHandler(handleFailure)
            .getAdminPageData(sessionToken);
    });

    function onDataLoaded(data) {
        sites = data.sites || [];
        users = data.users || [];
        approvers = data.approvers || [];
        currentUser = data.currentUser || {};
        
        populateSitesTable();
        populateUsersTable();
        populateApproversTable();
        populateSelectOptions();
        
        const sitesPanel = document.getElementById('sites-panel');
        const adminGrid = document.querySelector('.admin-grid');
        if (currentUser.role === ROLES.SITE_SUPERVISOR) {
          if(sitesPanel) sitesPanel.style.display = 'none';
          if(adminGrid) adminGrid.style.gridTemplateColumns = '1fr';
        } else {
           if(sitesPanel) sitesPanel.style.display = 'block';
        }

        setLoading(false);
        closeAllModals();
    }
    
    function populateSelectOptions() {
        const siteOptions = sites.map(s => `<option value="${s.siteId}">${s.siteName}</option>`).join('');
        document.getElementById('user-siteId').innerHTML = siteOptions;
        document.getElementById('approver-siteId').innerHTML = siteOptions;
        
        let roleOptions = '';
        if (currentUser.role === ROLES.SUPER_USER) roleOptions = Object.values(ROLES).map(r => `<option value="${r}">${r}</option>`).join('');
        else if (currentUser.role === ROLES.REGIONAL_MANAGER) roleOptions = `<option value="${ROLES.SITE_SUPERVISOR}">${ROLES.SITE_SUPERVISOR}</option>`;
        else if (currentUser.role === ROLES.SITE_SUPERVISOR) roleOptions = `<option value="${ROLES.SECURITY_OFFICER}">${ROLES.SECURITY_OFFICER}</option>`;
        document.getElementById('user-role').innerHTML = roleOptions;
    }

    function setLoading(isLoading) { document.getElementById('loader-overlay').style.display = isLoading ? 'flex' : 'none'; }
    
    function handleFailure(err) {
        setLoading(false);
        if (err.message.includes("Access Denied") || err.message.includes("Authentication failed") || err.message.includes("session may have expired")) {
            sessionStorage.removeItem('sessionToken');
            const modal = document.getElementById('session-timeout-modal');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('session-timeout-button').onclick = () => {
                    window.top.location.href = '<?= ScriptApp.getService().getUrl() ?>';
                };
            }
        } else {
            alert('An unexpected error occurred: ' + err.message);
        }
    }

    function showModal(modalId) { document.getElementById(modalId).style.display = 'block'; }
    function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }
    function closeAllModals() {
        closeModal('user-modal');
        closeModal('site-modal');
        closeModal('approver-modal');
    }

    function onActionSuccess(response) {
      alert(response.message);
      setLoading(true);
      google.script.run
        .withSuccessHandler(onDataLoaded)
        .withFailureHandler(handleFailure)
        .getAdminPageData(sessionToken);
    }

    function populateSitesTable() {
        const tableBody = document.getElementById('sites-table-body');
        tableBody.innerHTML = sites.map(site => {
            const apmEmails = [site.apmEmail1, site.apmEmail2].filter(Boolean).join('<br>');
            return `
            <tr>
                <td>${site.siteId}</td>
                <td>${site.siteName}</td>
                <td>${apmEmails || 'N/A'}</td>
                <td class="action-cell">
                    <button class="edit-btn" onclick="editSite('${site.siteId}')">Edit</button>
                    ${currentUser.role === ROLES.SUPER_USER ? `<button class="delete-btn" onclick="deleteSite('${site.siteId}')">Delete</button>` : ''}
                </td>
            </tr>`
        }).join('');
    }
    function openSiteModal(isEdit = false, siteId = null) {
        const form = document.getElementById('site-form');
        form.reset();
        document.getElementById('site-modal-title').textContent = isEdit ? 'Edit Site' : 'Add New Site';
        const idInput = document.getElementById('site-siteId');
        if (isEdit && siteId) {
            const site = sites.find(s => s.siteId === siteId);
            if(site) { 
              idInput.value = site.siteId; 
              idInput.readOnly = true; 
              document.getElementById('site-siteName').value = site.siteName;
              document.getElementById('site-apm-email1').value = site.apmEmail1 || '';
              document.getElementById('site-apm-email2').value = site.apmEmail2 || '';
            }
        } else {
            idInput.readOnly = false;
        }
        showModal('site-modal');
    }
    document.getElementById('site-form').addEventListener('submit', function(e) {
        e.preventDefault(); setLoading(true);
        const siteData = { 
          siteId: this.siteId.value, 
          siteName: this.siteName.value,
          apmEmail1: document.getElementById('site-apm-email1').value,
          apmEmail2: document.getElementById('site-apm-email2').value
        };
        const apiCall = document.getElementById('site-siteId').readOnly ? 'updateSite' : 'addSite';
        google.script.run.withSuccessHandler(onActionSuccess).withFailureHandler(handleFailure)[apiCall](sessionToken, siteData);
    });
    function editSite(siteId) { openSiteModal(true, siteId); }
    function deleteSite(siteId) {
        if (confirm(`Are you sure you want to delete site: ${siteId}?`)) {
            setLoading(true);
            google.script.run.withSuccessHandler(onActionSuccess).withFailureHandler(handleFailure).deleteSite(sessionToken, siteId);
        }
    }

    function populateUsersTable() {
        const tableBody = document.getElementById('users-table-body');
        tableBody.innerHTML = users.map(user => `
            <tr>
                <td>${user.fullName}</td><td>${user.username}</td><td>${user.role}</td><td>${user.siteId}</td>
                <td>${user.isActive ? 'Active' : 'Inactive'}</td>
                <td class="action-cell">
                    <button class="edit-btn" onclick="editUser('${user.username}')">Edit</button>
                    <button class="reset-btn" onclick="resetUserPassword('${user.username}')">Reset Pass</button>
                    ${currentUser.role === ROLES.SUPER_USER ? `<button class="delete-btn" onclick="deactivateUser('${user.username}')">Deactivate</button>` : ''}
                </td>
            </tr>`).join('');
    }
    function openUserModal(isEdit = false, username = null) {
        const form = document.getElementById('user-form');
        form.reset();
        document.getElementById('user-modal-title').textContent = isEdit ? 'Edit User' : 'Add New User';
        const userInput = document.getElementById('user-username');
        if (isEdit && username) {
            const user = users.find(u => u.username === username);
            if(user) {
                userInput.value = user.username;
                userInput.readOnly = true;
                document.getElementById('user-edit-username').value = user.username;
                document.getElementById('user-fullName').value = user.fullName;
                document.getElementById('user-position').value = user.position;
                document.getElementById('user-role').value = user.role;
                document.getElementById('user-siteId').value = user.siteId;
                document.getElementById('user-isActive').value = user.isActive.toString();
            }
        } else {
             userInput.readOnly = false;
        }
        showModal('user-modal');
    }
    document.getElementById('user-form').addEventListener('submit', function(e) {
        e.preventDefault(); setLoading(true);
        const userData = {
            username: this['user-username'].value,
            fullName: this['user-fullName'].value,
            position: this['user-position'].value,
            role: this['user-role'].value,
            siteId: this['user-siteId'].value,
            isActive: this['user-isActive'].value === 'true'
        };
        const apiCall = this['user-username'].readOnly ? 'updateUser' : 'addUser';
        google.script.run.withSuccessHandler(onActionSuccess).withFailureHandler(handleFailure)[apiCall](sessionToken, userData);
    });
    function editUser(username) { openUserModal(true, username); }
    function deactivateUser(username) {
        if (confirm(`This will mark ${username} as INACTIVE. Proceed?`)) {
            setLoading(true);
            google.script.run.withSuccessHandler(onActionSuccess).withFailureHandler(handleFailure).deleteUser(sessionToken, username);
        }
    }
    function resetUserPassword(username) {
        if (confirm(`Reset password for ${username}? The new password will be their username.`)) {
            setLoading(true);
            google.script.run.withSuccessHandler(onActionSuccess).withFailureHandler(handleFailure).resetPassword(sessionToken, username);
        }
    }

    function populateApproversTable() {
        const tableBody = document.getElementById('approvers-table-body');
        tableBody.innerHTML = approvers.map(approver => `
            <tr><td>${approver.fullName}</td><td>${approver.email}</td><td>${approver.siteId}</td>
                <td class="action-cell">
                    <button class="edit-btn" onclick="editApprover('${approver.approverId}')">Edit</button>
                    <button class="delete-btn" onclick="deleteApprover('${approver.approverId}')">Delete</button>
                </td></tr>`).join('');
    }
    function openApproverModal(isEdit = false, approverId = null) {
        const form = document.getElementById('approver-form');
        form.reset();
        document.getElementById('approver-modal-title').textContent = isEdit ? 'Edit Approver' : 'Add New Approver';
        document.getElementById('approver-edit-id').value = '';
        if (isEdit && approverId) {
            const approver = approvers.find(a => a.approverId === approverId);
            if(approver) {
                document.getElementById('approver-edit-id').value = approver.approverId;
                document.getElementById('approver-fullName').value = approver.fullName;
                document.getElementById('approver-email').value = approver.email;
                document.getElementById('approver-siteId').value = approver.siteId;
            }
        }
        showModal('approver-modal');
    }
    document.getElementById('approver-form').addEventListener('submit', function(e) {
        e.preventDefault(); setLoading(true);
        const approverData = {
            approverId: this['approver-edit-id'].value,
            fullName: this['approver-fullName'].value,
            email: this['approver-email'].value,
            siteId: this['approver-siteId'].value,
        };
        const apiCall = approverData.approverId ? 'updateApprover' : 'addApprover';
        google.script.run.withSuccessHandler(onActionSuccess).withFailureHandler(handleFailure)[apiCall](sessionToken, approverData);
    });
    function editApprover(approverId) { openApproverModal(true, approverId); }
    function deleteApprover(approverId) {
        if (confirm('Are you sure you want to delete this approver?')) {
            setLoading(true);
            google.script.run.withSuccessHandler(onActionSuccess).withFailureHandler(handleFailure).deleteApprover(sessionToken, approverId);
        }
    }
    </script>
</body>
</html>
