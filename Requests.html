<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #005f90;
            --light-gray: #eef2f5;
            --dark-text: #333;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #d9534f;
        }
        body { font-family: 'Roboto', sans-serif; background-color: var(--light-gray); margin: 0; }

        .header { 
            background-color: #ffffff; 
            padding: 1rem 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #d5d8db;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .header .logo {
            height: 40px;
        }
        .header-buttons {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .btn-link, .btn-logout {
            padding: 0.6rem 1.2rem;
            color: white;
            font-weight: 500;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
            font-size: 0.9rem;
        }
        .btn-link { background-color: var(--primary-color); }
        .btn-link:hover { background-color: #004c7a; }
        .btn-logout { background-color: var(--danger-color); }
        .btn-logout:hover { background-color: #c9302c; }

        .main-container { padding: 2rem; }
        
        .filter-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1.5rem;
        }
        .search-container {
            width: 100%;
            max-width: 350px;
        }
        #request-search-bar {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box;
        }
        .view-toggle button {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border-color);
            background-color: #fff;
            cursor: pointer;
            color: var(--primary-color);
        }
        .view-toggle button:first-child { border-radius: 5px 0 0 5px; }
        .view-toggle button:last-child { border-radius: 0 5px 5px 0; border-left: none; }
        .view-toggle button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .tabs { display: flex; gap: 0.5rem; }
        .tab { padding: 1rem 1.5rem; cursor: pointer; border-bottom: 1px solid transparent; font-weight: 500; }
        .tab.active { background-color: white; border-bottom: 1px solid white; position: relative; top: 1px; border-radius: 5px 5px 0 0; border: 1px solid var(--border-color); border-bottom-color: white;}
        
        #requests-container.grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .request-card { background-color: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .grid-view .request-card { padding: 1.5rem; }
        .grid-view .request-card:hover { transform: translateY(-4px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .card-id { font-weight: 700; color: var(--primary-color); font-size: 1.1rem; }
        .card-status { padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.8rem; font-weight: 500; color: white; white-space: nowrap; }
        
        #requests-container.list-view { display: flex; flex-direction: column; gap: 0.75rem; }
        .list-view .request-card { display: grid; grid-template-columns: 1fr 1fr 1fr auto; align-items: center; padding: 1rem 1.5rem; gap: 1rem; }
        .list-view .request-card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-left: 4px solid var(--primary-color); }
        .list-view .card-header { margin-bottom: 0; }
        .list-view .card-content { display: contents; }
        .list-view .request-card > div { text-align: left; }
        .list-view .card-id, .list-view .card-content p { margin: 0; font-size: 0.95rem; }

        #loader { text-align: center; padding: 3rem; font-size: 1.2rem; color: #6c757d; display: none; }
        
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 5% auto; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 900px; display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { padding: 1rem 2rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.5rem; color: var(--primary-color); margin: 0; }
        .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-footer { padding: 1rem 2rem; border-top: 1px solid var(--border-color); text-align: right; background-color: #f8f9fa; }
        .modal-body { padding: 2.5rem; overflow-y: auto; }
        .modal-body h2 { text-align: left; color: var(--primary-color); border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; margin-top: 0; margin-bottom: 1.5rem; font-size: 1.4em; }
        .details-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 1.5rem; text-align: left; }
        .detail-item { background-color: #f8f9fa; border: 1px solid #e0e5e9; border-radius: 10px; padding: 15px 20px; display: flex; flex-direction: column; gap: 4px; }
        .detail-item strong { color: var(--primary-color); font-size: 0.9em; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .detail-item span { font-size: 1.1em; color: var(--dark-text); word-wrap: break-word; }
        
        .photo-gallery { margin-top: 1.5rem; }
        .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .photo-item a { display: block; }
        .photo-item img { width: 100%; height: auto; border-radius: 8px; border: 1px solid var(--border-color); transition: transform 0.2s; }
        .photo-item img:hover { transform: scale(1.05); }

        .timeline { margin-top: 1.5rem; }
        .timeline h2 { margin-top: 2rem; }
        .timeline-item { position: relative; padding-left: 25px; margin-bottom: 15px; }
        .timeline-item::before { content: ''; position: absolute; left: 5px; top: 5px; width: 10px; height: 10px; background-color: #ccc; border-radius: 50%; }
        .timeline-item p { margin: 0; }

        /* Styles for the session timeout modal */
        .timeout-modal-overlay { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .timeout-modal-content { background-color: #fefefe; margin: auto; padding: 2rem 2.5rem; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 450px; text-align: center; }
        .timeout-modal-content h2 { margin-top: 0; color: #005f90; }
        #session-timeout-button { margin-top: 1rem; }
    </style>
</head>
<body>
    <div class="header">
        <img src="https://appscript-cdn.co.uk/GatePassProject/approva/Approva_favicon.png" alt="Approva Logo" class="logo">
        <div class="header-buttons">
            <a href="<?= ScriptApp.getService().getUrl() ?>?page=Landing" class="btn-link">Main Menu</a>
        </div>
    </div>

    <div class="main-container">
        <div class="filter-controls">
             <div class="tabs">
                <div id="tab-active" class="tab active" onclick="switchTab('active')">Active Requests</div>
                <div id="tab-completed" class="tab" onclick="switchTab('completed')">Completed Requests</div>
            </div>
            
            <div class="view-toggle">
                <button id="grid-view-btn" onclick="setView('grid')">Grid</button>
                <button id="list-view-btn" onclick="setView('list')">List</button>
            </div>
            
            <div class="search-container">
                <input type="text" id="request-search-bar" placeholder="Search by ID, Name, Approver..." onkeyup="handleSearch()">
            </div>
        </div>

        <div id="requests-container" class="grid-view"></div>
        <div id="loader">Loading requests...</div>
    </div>

    <div id="request-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title" class="modal-title">Request Details</h2>
                <span class="close-button" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-footer" class="modal-footer"></div>
        </div>
    </div>

    <div id="session-timeout-modal" class="timeout-modal-overlay">
      <div class="timeout-modal-content">
        <h2>Session Expired</h2>
        <p>Your session has timed out due to inactivity. Please log in again to continue.</p>
        <button id="session-timeout-button" class="btn-link">Go to Login</button>
      </div>
    </div>

    <script>
        const requestsContainer = document.getElementById('requests-container');
        const loader = document.getElementById('loader');
        const modal = document.getElementById('request-modal');
        const modalBody = document.getElementById('modal-body');
        const modalTitle = document.getElementById('modal-title');
        const modalFooter = document.getElementById('modal-footer');
        let sessionToken = '';
        let currentStatusFilter = 'active';
        let currentView = 'grid';
        let searchTimeout;
        let allCurrentRequests = [];

        document.addEventListener('DOMContentLoaded', () => {
            sessionToken = sessionStorage.getItem('sessionToken');
            if (!sessionToken) {
    const modal = document.getElementById('session-timeout-modal');
    if (modal) {
        modal.style.display = 'flex';
        const modalButton = document.getElementById('session-timeout-button');
        if (modalButton) {
            modalButton.onclick = () => {
                window.top.location.href = '<?= ScriptApp.getService().getUrl() ?>';
            };
        }
    }
    return; // Stop the rest of the script from running
}

            const savedView = localStorage.getItem('requestView');
            if (savedView) {
                setView(savedView, true);
            } else {
                setView('grid', true);
            }
            fetchData(currentStatusFilter);
        });

        function setView(viewType, suppressRender = false) {
            currentView = viewType;
            const gridBtn = document.getElementById('grid-view-btn');
            const listBtn = document.getElementById('list-view-btn');
            
            requestsContainer.className = viewType + '-view';

            gridBtn.classList.toggle('active', viewType === 'grid');
            listBtn.classList.toggle('active', viewType === 'list');
            
            localStorage.setItem('requestView', viewType);
            if (!suppressRender) {
              displayRequests(allCurrentRequests);
            }
        }

        function switchTab(statusFilter) {
            currentStatusFilter = statusFilter;
            document.getElementById('tab-active').classList.toggle('active', statusFilter === 'active');
            document.getElementById('tab-completed').classList.toggle('active', statusFilter === 'completed');
            document.getElementById('request-search-bar').value = '';
            fetchData(statusFilter);
        }
        
        function handleSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const searchTerm = document.getElementById('request-search-bar').value.toLowerCase();
                if (!searchTerm) {
                    displayRequests(allCurrentRequests);
                    return;
                }
                const filteredRequests = allCurrentRequests.filter(req => 
                    (req.id && req.id.toLowerCase().includes(searchTerm)) ||
                    (req.name && req.name.toLowerCase().includes(searchTerm)) ||
                    (req.approver && req.approver.toLowerCase().includes(searchTerm))
                );
                displayRequests(filteredRequests);
            }, 300);
        }

        function fetchData(statusFilter) {
            loader.style.display = 'block';
            requestsContainer.innerHTML = '';
            google.script.run
                .withSuccessHandler(onDataReceived)
                .withFailureHandler(handleFailure)
                .getRequestsAndTimeline(sessionToken, statusFilter);
        }
        
        function onDataReceived(response) {
            loader.style.display = 'none';
            if (!response.success) { 
                handleFailure({ message: response.error }); 
                return; 
            }
            allCurrentRequests = response.data || [];
            displayRequests(allCurrentRequests);
        }

        function displayRequests(requestsToDisplay) {
            requestsContainer.innerHTML = '';
            if (!requestsToDisplay || requestsToDisplay.length === 0) { 
              requestsContainer.innerHTML = `<p>No requests found.</p>`; 
              return;
            }
            
            requestsToDisplay.forEach(req => {
                const card = document.createElement('div');
                card.className = 'request-card';
                card.onclick = () => openModal(req);
                const statusColor = getStatusColor(req.status);
                
                if (currentView === 'grid') {
                     card.innerHTML = `
                        <div class="card-header"><div class="card-id">${req.id}</div><div class="card-status" style="background-color: ${statusColor};">${req.status}</div></div>
                        <div class="card-content"><p><strong>Date:</strong> ${req.date}</p><p><strong>Name:</strong> ${req.name}</p><p><strong>Approver:</strong> ${req.approver}</p></div>`;
                } else {
                    card.innerHTML = `
                        <div class="card-id"><strong>ID:</strong> ${req.id}</div>
                        <div class="card-content"><p><strong>Name:</strong> ${req.name}</p></div>
                        <div class="card-content"><p><strong>Approver:</strong> ${req.approver}</p></div>
                        <div class="card-status" style="background-color: ${statusColor};">${req.status}</div>`;
                }
                requestsContainer.appendChild(card);
            });
        }
        
        function openModal(req) {
            modalTitle.textContent = `Submission ID: ${req.id}`;
            
            let detailsGridHtml = '<div class="details-grid">';
            const imageIds = req.fullDetails['Image IDs'];
            for (const key in req.fullDetails) {
                const displayName = key.replace(/ - Answer/g, '').replace(/_/g, ' ');
                if (key !== 'Image IDs' && req.fullDetails[key]) {
                    detailsGridHtml += `<div class="detail-item"><strong>${displayName}</strong> <span>${req.fullDetails[key]}</span></div>`;
                }
            }
            detailsGridHtml += '</div>';

            let photoGalleryHtml = '';
            if (imageIds && imageIds.length > 0) {
                photoGalleryHtml = `<div class="photo-gallery">
                                        <h2>Attached Photos</h2>
                                        <div id="modal-photo-grid" class="photo-grid"><p>Loading photos...</p></div>
                                    </div>`;
            }

            let timelineHtml = '<div class="timeline"><h2>Timeline</h2>';
            if (req.timeline && req.timeline.length > 0) {
                req.timeline.forEach(item => {
                    timelineHtml += `<div class="timeline-item"><p><strong>${item.timestamp}</strong></p><p>${item.event} by ${item.user}</p></div>`;
                });
            } else { timelineHtml += '<p>No timeline events recorded.</p>'; }
            timelineHtml += '</div>';

            modalBody.innerHTML = `<h2>Request Details</h2>${detailsGridHtml}${photoGalleryHtml}${timelineHtml}`;
            
            if (imageIds && imageIds.length > 0) {
                google.script.run
                    .withSuccessHandler(displayPhotosInModal)
                    .withFailureHandler(err => { 
                        document.getElementById('modal-photo-grid').innerHTML = '<p style="color:red;">Could not load photos.</p>';
                    })
                    .getImageUrls(sessionToken, imageIds);
            }
            
            modalFooter.innerHTML = '';

            if (req.status === 'Approved' || req.status === 'Lodged') {
                const closeButton = document.createElement('button');
                closeButton.className = 'btn-link'; 
                closeButton.style.backgroundColor = 'var(--success-color)';
                closeButton.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M11.354 4.646a.5.5 0 0 1 0 .708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 1 1 .708-.708L8 7.293l2.646-2.647a.5.5 0 0 1 .708 0z"/>
                        <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/>
                        <path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0v-1a.5.5 0 0 1 .5-.5z"/>
                    </svg>
                    <span>Mark as Closed</span>`;
                closeButton.onclick = () => handleCloseRequest(req.id);
                modalFooter.appendChild(closeButton);
            }
            
            modal.style.display = 'block';
        }

        function displayPhotosInModal(photoUrls) {
            const grid = document.getElementById('modal-photo-grid');
            if (!grid || !photoUrls || photoUrls.length === 0) {
                if(grid) grid.innerHTML = '<p>No photos attached.</p>';
                return;
            }
            let gridHtml = '';
            photoUrls.forEach(url => {
                gridHtml += `<div class="photo-item"><a href="${url}" target="_blank"><img src="${url}" alt="Attached photo"></a></div>`;
            });
            grid.innerHTML = gridHtml;
        }

        function handleCloseRequest(id) {
            if (!confirm(`Are you sure you want to close the request ${id}?`)) return;
            loader.style.display = 'block';
            closeModal();
            google.script.run
                .withSuccessHandler(res => {
                    if (res.success) { fetchData(currentStatusFilter); } 
                    else { handleFailure({message: res.message}); }
                })
                .withFailureHandler(handleFailure)
                .updateTicketStatus(sessionToken, id, 'Closed');
        }

        function getStatusColor(status) {
            switch (status) {
                case 'Approved': return '#28a745';
                case 'Pending': return '#ffc107';
                case 'Rejected': return '#dc3545';
                case 'Closed': return '#6c757d';
                case 'Lodged': return '#17a2b8';
                default: return '#6c757d';
            }
        }
        function closeModal() { modal.style.display = 'none'; }
        
        function handleFailure(err) {
            loader.style.display = 'none'; 
            requestsContainer.innerHTML = `<p style="color: red;">Error: ${err.message}</p>`; 
            if (err.message.includes("Access Denied") || err.message.includes("Authentication failed") || err.message.includes("session may have expired")) {
                sessionStorage.removeItem('sessionToken');
                const sessionModal = document.getElementById('session-timeout-modal');
                if (sessionModal) {
                    sessionModal.style.display = 'flex';
                    document.getElementById('session-timeout-button').onclick = () => {
                        window.top.location.href = '<?= ScriptApp.getService().getUrl() ?>';
                    };
                }
            }
        }
        window.onclick = (event) => { if (event.target == modal) closeModal(); }
    </script>
</body>
</html>
